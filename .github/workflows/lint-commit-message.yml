name: 📝 Lint commit message

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['16']
        include:
          - node-version: '16'
            node-name: 'Latest'
    outputs:
      comment: ${{ steps.lint_commit.outputs.result }}
      lint_status: ${{ contains(steps.lint_commit.outputs.result, 'Command failed') }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Add dev branch
        run: git branch dev origin/dev
      - name: Setup pnpm
        uses: pnpm/action-setup@v2

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: Cache ~/.pnpm-store
        uses: actions/cache@v3
        env:
          cache-name: cache-pnpm-store
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-${{ matrix.node-version }}-test-${{ env.cache-name }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.node-version }}-test-${{ env.cache-name }}-
            ${{ runner.os }}-${{ matrix.node-version }}-test-
            ${{ runner.os }}-

      - name: Install dependencies
        run: pnpm i --frozen-lockfile
      - name: Lint commit message
        id: lint_commit
        run: |
          echo "::set-output name=tmp::$(pnpm link:commit)"
          echo "::set-output name=result::$(cat ./commit-lint.txt)"

  on-success:
    runs-on: ubuntu-latest
    needs: lint
    if: ${{ needs.lint.outputs.lint_status == 'true' }}
    name: Lint successfully
    steps:
      - uses: actions-awesome/pr-helper@1.0.16
        with:
          actions: 'add-labels'
          labels: 'CommitMessage::Qualified'
      - uses: actions-awesome/pr-helper@1.0.16
        with:
          actions: 'remove-labels'
          labels: 'CommitMessage::Unqualified'
      - uses: actions-cool/maintain-one-comment@v2.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body-include: '<!-- ELEMENT_PLUS_COMMIT_LINT -->'

  on-failed:
    runs-on: ubuntu-latest
    needs: lint
    name: Lint failed
    if: ${{ needs.lint.outputs.lint_status == 'false' }}
    steps:
      - uses: actions-awesome/pr-helper@1.0.16
        with:
          actions: 'add-labels'
          labels: 'CommitMessage::Unqualified'
      - uses: actions-awesome/pr-helper@1.0.16
        with:
          actions: 'remove-labels'
          labels: 'CommitMessage::Qualified'

      - name: Debug
        run: echo "::debug::$(cat ./commit-lint.txt)"
      - uses: actions-cool/maintain-one-comment@v2.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            Hello, @${{ github.event.pull_request.user.login }}, seems like your commit message contains some issues.

            你好，@${{ github.event.pull_request.user.login }}，你的提交消息不符合 Element Plus 的提交消息规范。

            ${{ needs.lint.outputs.comment }}

            Please refer to [Commit Example](https://github.com/element-plus/element-plus/blob/dev/commit-example.md) for fixing it.

            请参考 [提交示例](https://github.com/element-plus/element-plus/blob/dev/commit-example.md) 来修改你的提交消息。

            Note that all your commits will be squashed into one for being linted, so you might need to revision your commits.
            If you do not know how to do so, please refer to [Keeping git commit history clean](https://about.gitlab.com/blog/2018/06/07/keeping-git-commit-history-clean/) to update your commit message.

            你的所有 commit(s) 会被合并为一个 commit 来被验证，所以你可能需要修改你之前的 commit(s) 消息。
            如果你不知道如果来修改之前已经提交的记录，请参考 [让你的 Git 提交历史保持干净](https://about.gitlab.com/blog/2018/06/07/keeping-git-commit-history-clean/) 来修改。

            Note that if you do not fix the commit message issue, your PR will be automatically closed within 1 day.

            请注意，如果你没有按照规范修改你的提交消息，你的 PR 将会在一天内被自动关闭。

            <sub>Generated with :heart: by ElementPlusBot</sub>
            <!-- ELEMENT_PLUS_COMMIT_LINT -->
          body-include: '<!-- ELEMENT_PLUS_COMMIT_LINT -->'
